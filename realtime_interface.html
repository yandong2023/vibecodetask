<!DOCTYPE html>
<html lang="en" id="htmlRoot">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="app.title">VibeCodeTask - Real-time Version</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            opacity: 0.9;
            margin-top: 10px;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #4CAF50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 20px;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* TokençŠ¶æ€é¢æ¿ */
        .token-panel {
            background: linear-gradient(135deg, #48dbfb 0%, #0abde3 100%);
            border-radius: 15px;
            padding: 25px;
            color: white;
            margin-bottom: 20px;
        }

        .token-panel.warning {
            background: linear-gradient(135deg, #feca57 0%, #ff9ff3 100%);
        }

        .token-panel.critical {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }

        .token-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .token-card {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .token-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .token-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .block-info {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .block-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .block-detail {
            text-align: center;
            font-size: 14px;
        }

        .block-detail-value {
            font-weight: bold;
            font-size: 16px;
        }

        .last-updated {
            text-align: right;
            font-size: 12px;
            opacity: 0.8;
            margin-top: 10px;
        }

        /* ä»»åŠ¡åŒºåŸŸ */
        .add-task {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
        }

        .task-input {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            resize: vertical;
            min-height: 100px;
            margin-bottom: 15px;
            transition: border-color 0.3s;
        }

        .task-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-danger {
            background: #ff6b6b;
            color: white;
        }

        .btn-danger:hover {
            background: #ff5252;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .time-input {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        /* ä»»åŠ¡åˆ—è¡¨ */
        .task-list {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            max-height: 600px;
            overflow-y: auto;
        }

        .task-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: all 0.3s;
            animation: slideIn 0.3s ease;
        }

        .task-item:hover {
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            transform: translateY(-1px);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .task-content {
            flex: 1;
        }

        .task-title {
            font-weight: 600;
            color: #333;
            font-size: 16px;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .task-meta {
            font-size: 14px;
            color: #666;
            line-height: 1.4;
        }

        .task-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-running {
            background: #d4edda;
            color: #155724;
        }

        .status-completed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-failed {
            background: #f8d7da;
            color: #721c24;
        }

        .task-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* æé†’æ¶ˆæ¯ */
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: slideIn 0.3s ease;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .alert-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            opacity: 0.7;
        }

        .alert-close:hover {
            opacity: 1;
        }

        /* æ§åˆ¶é¢æ¿ */
        .control-panel {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .status-bar {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* è¯­è¨€åˆ‡æ¢æŒ‰é’® */
        .language-switcher {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            gap: 2px;
        }
        
        .lang-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 20px;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            color: #666;
        }
        
        .lang-btn.active {
            background: #667eea;
            color: white;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }
        
        .lang-btn:hover:not(.active) {
            background: #f0f0f0;
            color: #333;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 24px;
            }

            .token-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .button-row {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .history-summary {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .history-stats {
                flex-direction: column;
                gap: 5px;
            }
            
            .simple-chart svg {
                min-width: 600px; /* ç§»åŠ¨ç«¯ä¿æŒè¶³å¤Ÿå®½åº¦ä»¥æ˜¾ç¤ºåŒè½´ */
            }
        }
        
        /* å†å²æ•°æ®æ ·å¼ */
        .history-panel {
            padding: 20px 0;
        }
        
        .history-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .history-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .history-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .history-value {
            font-size: 28px;
            font-weight: bold;
            color: #495057;
            margin-bottom: 8px;
        }
        
        .history-label {
            font-size: 14px;
            color: #6c757d;
            font-weight: 500;
        }
        
        .history-details {
            margin-top: 20px;
        }
        
        .history-chart-container {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-header h3 {
            margin: 0;
            color: #495057;
            font-size: 18px;
        }
        
        .chart-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .chart-type-toggle {
            display: flex;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }
        
        .chart-type-btn {
            padding: 8px 16px;
            border: none;
            background: white;
            color: #6c757d;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border-right: 1px solid #dee2e6;
        }
        
        .chart-type-btn:last-child {
            border-right: none;
        }
        
        .chart-type-btn:hover {
            background: #f8f9fa;
            color: #495057;
        }
        
        .chart-type-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .chart-controls select {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            background: white;
            font-size: 14px;
        }
        
        .simple-chart {
            min-height: 200px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            margin-bottom: 20px;
            overflow-x: auto;
        }
        
        .simple-chart svg {
            min-width: 600px; /* ç¡®ä¿åœ¨å°å±å¹•ä¸Šå›¾è¡¨ä¸ä¼šè¿‡äºå‹ç¼© */
        }
        
        /* å›¾è¡¨å·¥å…·æç¤ºæ ·å¼ä¼˜åŒ– */
        #chartTooltip {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            white-space: nowrap;
        }
        
        .history-list {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-item:hover {
            background: #f8f9fa;
        }
        
        .history-date {
            font-weight: 500;
            color: #495057;
        }
        
        .history-stats {
            display: flex;
            gap: 20px;
            font-size: 14px;
        }
        
        .history-stat {
            text-align: right;
        }
        
        .history-stat-value {
            font-weight: bold;
            color: #495057;
        }
        
        .history-stat-label {
            color: #6c757d;
            font-size: 12px;
        }
        
        .btn-sm {
            padding: 5px 12px;
            font-size: 12px;
            margin-left: auto;
        }
    </style>
</head>
<body>
    <!-- è¯­è¨€åˆ‡æ¢å™¨ -->
    <div class="language-switcher">
        <button class="lang-btn active" data-lang="en" onclick="switchLanguage('en')">ğŸ‡¬ğŸ‡§ EN</button>
        <button class="lang-btn" data-lang="zh" onclick="switchLanguage('zh')">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</button>
    </div>

    <div class="container">
        <div class="header">
            <h1>ğŸš€ <span data-i18n="app.title">VibeCodeTask - Real-time Version</span></h1>
            <p data-i18n="app.description">Intelligent task automation platform powered by Claude</p>
            <div class="live-indicator">
                <div class="live-dot"></div>
                <span data-i18n="header.liveIndicator">System Live</span>
            </div>
        </div>

        <div class="content">
            <!-- æé†’åŒºåŸŸ -->
            <div id="alertContainer"></div>

            <!-- Tokenå®æ—¶çŠ¶æ€ -->
            <div class="section">
                <h2 class="section-title">
                    <span>ğŸ’°</span>
                    <span data-i18n="tokenMonitor.title">Token Usage Monitor</span>
                </h2>
                
                <div class="token-panel" id="tokenPanel">
                    <div class="token-grid">
                        <div class="token-card">
                            <div class="token-value" id="totalTokens" data-i18n="tokenMonitor.refreshing">Refreshing...</div>
                            <div class="token-label" data-i18n="tokenMonitor.todayUsage">Today's Usage</div>
                        </div>
                        <div class="token-card">
                            <div class="token-value" id="totalCost">$0.00</div>
                            <div class="token-label" data-i18n="tokenMonitor.cost">Cost</div>
                        </div>
                        <div class="token-card">
                            <div class="token-value" id="blockEntries">0</div>
                            <div class="token-label" data-i18n="tokenMonitor.todayUsage">Today's Usage</div>
                        </div>
                        <div class="token-card">
                            <div class="token-value" id="burnRate">0/min</div>
                            <div class="token-label">Usage Rate</div>
                        </div>
                    </div>

                    <div class="block-info">
                        <div><strong data-i18n="tokenMonitor.title">Token Usage Monitor</strong></div>
                        <div class="block-details">
                            <div class="block-detail">
                                <div class="block-detail-value" id="blockStatus" data-i18n="tokenMonitor.refreshing">Refreshing...</div>
                                <div>Status</div>
                            </div>
                            <div class="block-detail">
                                <div class="block-detail-value" id="blockTokens">0</div>
                                <div data-i18n="tokenMonitor.tokens">tokens</div>
                            </div>
                            <div class="block-detail">
                                <div class="block-detail-value" id="blockCost">$0.00</div>
                                <div data-i18n="tokenMonitor.cost">Cost</div>
                            </div>
                            <div class="block-detail">
                                <div class="block-detail-value" id="remainingTime">--</div>
                                <div data-i18n="tokenMonitor.remaining">Remaining</div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 15px; font-size: 14px; opacity: 0.9;">
                        Models: <span id="modelsUsed">--</span>
                    </div>

                    <div class="last-updated">
                        Last Updated: <span id="lastUpdated">--</span>
                    </div>
                </div>
            </div>

            <!-- çŠ¶æ€æ  -->
            <div class="status-bar">
                <div class="status-item">
                    <span>ğŸ”—</span>
                    <span id="connectionStatus" data-i18n="header.connectionStatus.disconnected">Disconnected</span>
                </div>
                <div class="status-item">
                    <span>ğŸ“Š</span>
                    <span>Tasks: <span id="taskStats">0</span></span>
                </div>
                <div class="status-item">
                    <span>âš¡</span>
                    <span id="systemStatus">System Standby</span>
                </div>
            </div>

            <!-- å†å²ä½¿ç”¨æ•°æ® -->
            <div class="section">
                <h2 class="section-title">
                    <span>ğŸ“ˆ</span>
                    <span>Usage History</span>
                    <button class="btn btn-sm" onclick="toggleHistoryView()" id="historyToggleBtn">Show Details</button>
                </h2>
                
                <div class="history-panel" id="historyPanel">
                    <!-- å†å²æ¦‚è§ˆ -->
                    <div class="history-summary" id="historySummary">
                        <div class="history-card">
                            <div class="history-value" id="totalDays">--</div>
                            <div class="history-label">Total Days</div>
                        </div>
                        <div class="history-card">
                            <div class="history-value" id="monthlyTokens">--</div>
                            <div class="history-label">Total Tokens</div>
                        </div>
                        <div class="history-card">
                            <div class="history-value" id="monthlyCost">--</div>
                            <div class="history-label">Total Cost</div>
                        </div>
                        <div class="history-card">
                            <div class="history-value" id="averageDaily">--</div>
                            <div class="history-label">Daily Average</div>
                        </div>
                        <div class="history-card">
                            <div class="history-value" id="usageTrend">--</div>
                            <div class="history-label">Usage Trend</div>
                        </div>
                    </div>
                    
                    <!-- è¯¦ç»†å†å²æ•°æ® -->
                    <div class="history-details" id="historyDetails" style="display: none;">
                        <div class="history-chart-container">
                            <div class="chart-header">
                                <h3>Daily Usage Trend</h3>
                                <div class="chart-controls">
                                    <div class="chart-type-toggle">
                                        <button class="chart-type-btn active" id="tokenBtn" onclick="switchChartType('token')">Token Usage</button>
                                        <button class="chart-type-btn" id="costBtn" onclick="switchChartType('cost')">Cost</button>
                                    </div>
                                    <select id="historyDays" onchange="loadHistoryData()">
                                        <option value="7">Last 7 days</option>
                                        <option value="15">Last 15 days</option>
                                        <option value="30" selected>Last 30 days</option>
                                    </select>
                                </div>
                            </div>
                            <div class="simple-chart" id="historyChart" data-i18n="tokenMonitor.refreshing">
                                Refreshing...
                            </div>
                        </div>
                        
                        <div class="history-list" id="historyList">
                            <!-- å†å²æ•°æ®åˆ—è¡¨ -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ·»åŠ ä»»åŠ¡ -->
            <div class="section">
                <h2 class="section-title">
                    <span>â•</span>
                    <span data-i18n="taskForm.title">Create Task</span>
                </h2>
                
                <div class="add-task">
                    <textarea 
                        class="task-input" 
                        id="taskInput" 
                        placeholder="è¯·è¯¦ç»†æè¿°ä½ æƒ³è®©Claudeå®Œæˆçš„ä»»åŠ¡...&#10;&#10;ä¾‹å¦‚ï¼š&#10;â€¢ å¸®æˆ‘ç”¨HTMLå’ŒJavaScriptåˆ›å»ºä¸€ä¸ªè´ªåƒè›‡æ¸¸æˆ&#10;â€¢ å†™ä¸€ä¸ªPythonè„šæœ¬åˆ†æCSVæ•°æ®å¹¶ç”Ÿæˆå›¾è¡¨&#10;â€¢ ä¼˜åŒ–è¿™æ®µä»£ç çš„æ€§èƒ½å¹¶æ·»åŠ é”™è¯¯å¤„ç†"></textarea>
                    
                    <div class="button-row">
                        <button class="btn btn-primary" onclick="addTask('immediate')" id="addImmediateBtn">
                            âš¡ <span data-i18n="taskForm.immediate">Execute Immediately</span>
                        </button>
                        
                        <input type="time" class="time-input" id="scheduledTime" value="12:00">
                        <button class="btn btn-secondary" onclick="addTask('scheduled')">
                            â° <span data-i18n="taskForm.scheduled">Scheduled Execution</span>
                        </button>
                        
                        <button class="btn btn-secondary" onclick="addTask('smart')">
                            ğŸ¤– <span data-i18n="taskForm.smart">Smart Schedule</span>
                        </button>
                        
                        <div style="margin-left: auto;">
                            <button class="btn btn-secondary" onclick="refreshAll()">
                                ğŸ”„ <span data-i18n="actions.refresh">Refresh</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä»»åŠ¡åˆ—è¡¨ -->
            <div class="section">
                <h2 class="section-title">
                    <span>ğŸ“‹</span>
                    <span data-i18n="taskList.title">Task List</span>
                </h2>
                
                <div class="task-list" id="taskList">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“</div>
                        <p data-i18n="taskList.noTasks">No tasks yet</p>
                    </div>
                </div>
            </div>

            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="control-panel">
                <button class="btn btn-primary" id="systemToggle" onclick="toggleSystem()">
                    â–¶ï¸ <span data-i18n="actions.startSystem">Start System</span>
                </button>
                <button class="btn btn-secondary" onclick="clearCompleted()">
                    ğŸ—‘ï¸ <span data-i18n="actions.clearCompleted">Clear Completed</span>
                </button>
                <button class="btn btn-secondary" onclick="exportData()">
                    ğŸ“¤ <span data-i18n="actions.exportData">Export Data</span>
                </button>
            </div>
        </div>
    </div>

    <script src="/i18n.js"></script>
    <script>
        // å…¨å±€çŠ¶æ€
        let systemRunning = false;
        let tasks = [];
        let tokenData = null;
        let refreshInterval = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            startRealTimeMonitoring();
        });

        // åº”ç”¨åˆå§‹åŒ–
        async function initializeApp() {
            // åˆå§‹åŒ–i18n
            await window.i18n.init();
            updateLanguageUI();
            
            updateConnectionStatus('Connected');
            refreshTokenStatus();
            refreshTasks();
            loadHistorySummary(); // åŠ è½½å†å²æ•°æ®æ¦‚è§ˆ
            
            // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡
            refreshInterval = setInterval(() => {
                refreshTokenStatus();
                refreshTasks();
            }, 30000);
        }
        
        // è¯­è¨€åˆ‡æ¢åŠŸèƒ½
        async function switchLanguage(lang) {
            await window.i18n.setLanguage(lang);
            updateLanguageUI();
        }
        
        // æ›´æ–°è¯­è¨€UI
        function updateLanguageUI() {
            const currentLang = window.i18n.getCurrentLanguage();
            
            // æ›´æ–°è¯­è¨€æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-lang') === currentLang);
            });
            
            // æ›´æ–°html langå±æ€§
            document.getElementById('htmlRoot').setAttribute('lang', currentLang);
            
            // è§¦å‘i18næ›´æ–°
            window.i18n.updateDOM();
            
            // é‡æ–°åŠ è½½ä¸€äº›åŠ¨æ€å†…å®¹çš„ç¿»è¯‘
            updateDynamicTranslations();
        }
        
        // æ›´æ–°åŠ¨æ€ç¿»è¯‘å†…å®¹
        function updateDynamicTranslations() {
            const i18n = window.i18n;
            
            // æ›´æ–°ä»»åŠ¡çŠ¶æ€æ–‡æœ¬æ˜ å°„
            window.statusTextMap = {
                'pending': i18n.t('taskList.status.pending'),
                'running': i18n.t('taskList.status.running'),
                'completed': i18n.t('taskList.status.completed'),
                'failed': i18n.t('taskList.status.failed')
            };
            
            // æ›´æ–°ä»»åŠ¡ç±»å‹æ–‡æœ¬æ˜ å°„
            window.taskTypeMap = {
                'immediate': i18n.t('taskList.type.immediate'),
                'scheduled': i18n.t('taskList.type.scheduled')
            };
            
            // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨ä»¥åº”ç”¨æ–°ç¿»è¯‘
            if (tasks && tasks.length > 0) {
                updateTaskList();
            }
        }

        // å¯åŠ¨å®æ—¶ç›‘æ§
        function startRealTimeMonitoring() {
            // å¯ä»¥å®ç°WebSocketæˆ–Server-Sent Events
            console.log('Real-time monitoring started');
        }

        // åˆ·æ–°TokençŠ¶æ€
        async function refreshTokenStatus() {
            try {
                updateConnectionStatus('Fetching data...');
                const response = await fetch('/api/token-status');
                
                if (response.ok) {
                    const data = await response.json();
                    tokenData = data;
                    updateTokenDisplay(data);
                    updateConnectionStatus('Connected');
                    
                    if (data.error) {
                        showAlert('warning', `âš ï¸ ${data.error}`);
                    }
                } else {
                    throw new Error('æœåŠ¡å™¨å“åº”é”™è¯¯');
                }
            } catch (error) {
                console.error('è·å–TokençŠ¶æ€å¤±è´¥:', error);
                updateConnectionStatus('Connection failed');
                showAlert('error', window.i18n.t('messages.error.networkError'));
            }
        }

        // æ›´æ–°Tokenæ˜¾ç¤º
        function updateTokenDisplay(data) {
            const panel = document.getElementById('tokenPanel');
            
            // æ ¹æ®çŠ¶æ€è®¾ç½®é¢æ¿æ ·å¼
            panel.className = 'token-panel';
            if (data.status === 'critical') {
                panel.className += ' critical';
            } else if (data.status === 'warning') {
                panel.className += ' warning';
            }

            // æ›´æ–°æ•°å€¼
            document.getElementById('totalTokens').textContent = formatNumber(data.totalTokens || 0);
            document.getElementById('totalCost').textContent = `$${(data.totalCost || 0).toFixed(2)}`;
            document.getElementById('blockEntries').textContent = data.blockInfo?.entries || 0;
            
            const burnRate = data.blockInfo?.burnRate?.tokensPerMinute || 0;
            document.getElementById('burnRate').textContent = `${Math.round(burnRate)}/min`;
            
            // æ›´æ–°Blockä¿¡æ¯
            const blockInfo = data.blockInfo || {};
            document.getElementById('blockStatus').textContent = blockInfo.isActive ? window.i18n.t('status.active') : window.i18n.t('status.waiting');
            document.getElementById('blockTokens').textContent = formatNumber(blockInfo.blockTokens || 0);
            document.getElementById('blockCost').textContent = `$${(blockInfo.blockCost || 0).toFixed(2)}`;
            
            const projection = blockInfo.projection || {};
            const remainingMinutes = projection.remainingMinutes || 0;
            document.getElementById('remainingTime').textContent = remainingMinutes > 0 ? `${remainingMinutes} ${window.i18n.t('time.minutes')}` : '--';
            
            // æ›´æ–°æ¨¡å‹ä¿¡æ¯
            const models = (data.modelsUsed || []).map(model => 
                model.replace('claude-', '').replace('-20250805', '').replace('-20250514', '')
            ).join(', ') || '--';
            document.getElementById('modelsUsed').textContent = models;
            
            // æ›´æ–°æ—¶é—´
            const updateTime = data.timestamp ? new Date(data.timestamp).toLocaleTimeString() : '--';
            document.getElementById('lastUpdated').textContent = updateTime;

            // æ ¹æ®TokençŠ¶æ€è°ƒæ•´æŒ‰é’®
            const addBtn = document.getElementById('addImmediateBtn');
            if (data.status === 'critical') {
                const i18n = window.i18n;
                addBtn.innerHTML = `ğŸš« <span data-i18n="messages.tokenInsufficient">${i18n.t('messages.tokenInsufficient') || 'Insufficient Tokens'}</span>`;
                addBtn.disabled = true;
                addBtn.className = 'btn btn-secondary';
            } else {
                const i18n = window.i18n;
                addBtn.innerHTML = `âš¡ <span data-i18n="taskForm.immediate">${i18n.t('taskForm.immediate') || 'Execute Immediately'}</span>`;
                addBtn.disabled = false;
                addBtn.className = 'btn btn-primary';
            }
        }

        // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
        async function refreshTasks() {
            try {
                const response = await fetch('/api/tasks');
                
                if (response.ok) {
                    const data = await response.json();
                    tasks = data.tasks || [];
                    updateTaskList();
                    updateTaskStats();
                } else {
                    console.error('è·å–ä»»åŠ¡åˆ—è¡¨å¤±è´¥');
                }
            } catch (error) {
                console.error('è·å–ä»»åŠ¡åˆ—è¡¨é”™è¯¯:', error);
            }
        }

        // æ›´æ–°ä»»åŠ¡åˆ—è¡¨æ˜¾ç¤º
        function updateTaskList() {
            const container = document.getElementById('taskList');
            
            if (tasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“</div>
                        <p>${window.i18n.t('taskList.noTasks')}</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = tasks.map(task => `
                <div class="task-item">
                    <div class="task-header">
                        <div class="task-content">
                            <div class="task-title">${escapeHtml(task.description)}</div>
                            <div class="task-meta">
                                ${getTaskTypeText(task)} | 
                                ${window.i18n.t('taskForm.estimatedTokens')}: ${formatNumber(task.estimatedTokens || 0)} ${window.i18n.t('tokenMonitor.tokens')} | 
                                ${formatDateTime(task.createdAt)}
                                ${task.filesCreated && task.filesCreated.length > 0 ? `<br>ğŸ“ ${window.i18n.t('messages.filesGenerated', {n: task.filesCreated.length})}` : ''}
                            </div>
                        </div>
                        <div class="task-status status-${task.status}">
                            ${getStatusText(task.status)}
                        </div>
                    </div>
                    
                    <div class="task-actions">
                        ${task.status === 'pending' ? `
                            <button class="btn btn-sm btn-primary" onclick="executeTask(${task.id})">
                                â–¶ï¸ Execute
                            </button>
                        ` : ''}
                        ${task.status === 'completed' && task.result ? `
                            <button class="btn btn-sm btn-secondary" onclick="viewResult(${task.id})">
                                ğŸ‘ï¸ ${window.i18n.t('taskList.viewResult')}
                            </button>
                        ` : ''}
                        ${task.status === 'completed' && task.taskDirectory ? `
                            <button class="btn btn-sm btn-secondary" onclick="openTaskDirectory('${task.taskDirectory}')">
                                ğŸ“ ${window.i18n.t('actions.openDirectory')}
                            </button>
                        ` : ''}
                        <button class="btn btn-sm btn-danger" onclick="deleteTask(${task.id})">
                            ğŸ—‘ï¸ ${window.i18n.t('taskList.delete')}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // æ·»åŠ ä»»åŠ¡
        async function addTask(type) {
            const input = document.getElementById('taskInput');
            const description = input.value.trim();
            
            if (!description) {
                showAlert('error', window.i18n.t('messages.error.emptyDescription'));
                return;
            }

            const scheduledTime = document.getElementById('scheduledTime').value;
            
            // å°†æ—¶é—´è½¬æ¢ä¸ºå®Œæ•´çš„ISOæ ¼å¼ï¼Œä¸ä»»åŠ¡è°ƒåº¦å™¨å…¼å®¹
            let scheduledTimeISO = null;
            if (type === 'scheduled' && scheduledTime) {
                const today = new Date();
                const [hours, minutes] = scheduledTime.split(':');
                let scheduledDate = new Date(today.getFullYear(), today.getMonth(), today.getDate(), parseInt(hours), parseInt(minutes));
                
                // å¦‚æœè®¾ç½®çš„æ—¶é—´å·²ç»è¿‡äº†ä»Šå¤©ï¼Œåˆ™è®¾ç½®ä¸ºæ˜å¤©
                const now = new Date();
                if (scheduledDate <= now) {
                    scheduledDate.setDate(scheduledDate.getDate() + 1);
                }
                
                // æ·»åŠ 30ç§’çš„å®‰å…¨è¾¹è·ï¼Œç¡®ä¿æ—¶é—´éªŒè¯ä¸ä¼šå› ä¸ºå¾®å°å»¶è¿Ÿå¤±è´¥
                scheduledDate.setSeconds(scheduledDate.getSeconds() + 30);
                
                // ä½¿ç”¨æœ¬åœ°æ—¶é—´çš„ISOæ ¼å¼ï¼Œç¡®ä¿æ—¶åŒºä¸€è‡´æ€§
                const year = scheduledDate.getFullYear();
                const month = (scheduledDate.getMonth() + 1).toString().padStart(2, '0');
                const day = scheduledDate.getDate().toString().padStart(2, '0');
                const hour = scheduledDate.getHours().toString().padStart(2, '0');
                const minute = scheduledDate.getMinutes().toString().padStart(2, '0');
                const second = scheduledDate.getSeconds().toString().padStart(2, '0');
                
                scheduledTimeISO = `${year}-${month}-${day}T${hour}:${minute}:${second}`;
                
                console.log(`[Frontend] æ—¶é—´ç”Ÿæˆè¯¦æƒ…:`);
                console.log(`   ç”¨æˆ·è¾“å…¥: ${scheduledTime}`);
                console.log(`   å½“å‰æ—¶é—´: ${now.toLocaleString()}`);
                console.log(`   è°ƒåº¦æ—¶é—´: ${scheduledDate.toLocaleString()}`);
                console.log(`   ç”ŸæˆISO: ${scheduledTimeISO}`);
                console.log(`   æ—¶é—´å·®: ${((scheduledDate - now) / 1000).toFixed(1)}ç§’`);
            }
            
            try {
                const response = await fetch('/api/add-task', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        description: description,
                        type: type,
                        scheduledTime: scheduledTimeISO
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    input.value = '';
                    const timeDisplay = type === 'scheduled' && scheduledTimeISO ? 
                        ` ${window.i18n.t('taskList.scheduledAt')} ${scheduledTime} (${new Date(scheduledTimeISO).toLocaleString()})` : '';
                    showAlert('success', `âœ… ${window.i18n.t('messages.taskCreated')}${timeDisplay}`);
                    refreshTasks();
                } else {
                    const error = await response.json();
                    showAlert('error', `${window.i18n.t('messages.error.createTask')}: ${error.error || window.i18n.t('messages.error.networkError')}`);
                }
            } catch (error) {
                console.error('æ·»åŠ ä»»åŠ¡å¤±è´¥:', error);
                showAlert('error', window.i18n.t('messages.error.networkError'));
            }
        }

        // åˆ é™¤ä»»åŠ¡
        async function deleteTask(taskId) {
            if (!confirm(window.i18n.t('taskList.confirmDelete'))) {
                return;
            }

            try {
                const response = await fetch('/api/delete-task', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        taskId: taskId
                    })
                });

                if (response.ok) {
                    showAlert('success', window.i18n.t('messages.taskDeleted'));
                    refreshTasks();
                } else {
                    showAlert('error', window.i18n.t('messages.error.deleteTask'));
                }
            } catch (error) {
                console.error('åˆ é™¤ä»»åŠ¡å¤±è´¥:', error);
                showAlert('error', window.i18n.t('messages.error.networkError'));
            }
        }

        // æ‰§è¡Œä»»åŠ¡
        async function executeTask(taskId) {
            try {
                showAlert('success', 'ğŸ”„ Starting task execution...');
                
                const response = await fetch('/api/execute-task', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        taskId: taskId
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    showAlert('success', `âœ… ${data.message}`);
                    
                    // 5ç§’ååˆ·æ–°ä»»åŠ¡åˆ—è¡¨æŸ¥çœ‹è¿›åº¦
                    setTimeout(() => {
                        refreshTasks();
                    }, 5000);
                } else {
                    const error = await response.json();
                    showAlert('error', `æ‰§è¡Œå¤±è´¥: ${error.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('æ‰§è¡Œä»»åŠ¡å¤±è´¥:', error);
                showAlert('error', 'æ‰§è¡Œä»»åŠ¡å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // æŸ¥çœ‹ç»“æœ
        function viewResult(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task || !task.result) return;

            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; max-width: 700px; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin-bottom: 15px; color: #333;">ğŸ“„ ä»»åŠ¡æ‰§è¡Œç»“æœ</h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <strong>ä»»åŠ¡æè¿°:</strong><br>
                        ${escapeHtml(task.description)}
                    </div>
                    <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; white-space: pre-wrap; font-family: 'Consolas', monospace; font-size: 14px; line-height: 1.6; max-height: 400px; overflow-y: auto;">
                        ${escapeHtml(task.result)}
                    </div>
                    <button onclick="this.closest('div').parentNode.remove()" style="background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin-top: 20px; font-size: 14px;">å…³é—­</button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // æ‰“å¼€ä»»åŠ¡ç›®å½•
        function openTaskDirectory(taskDirectory) {
            showAlert('success', `ğŸ“ ä»»åŠ¡æ–‡ä»¶ä¿å­˜åœ¨: ${taskDirectory}`);
            
            // æ˜¾ç¤ºç›®å½•ä¿¡æ¯æ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin-bottom: 15px; color: #333;">ğŸ“ ä»»åŠ¡æ–‡ä»¶ä½ç½®</h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <strong>æ–‡ä»¶ä¿å­˜ç›®å½•:</strong><br>
                        <code style="background: #e9ecef; padding: 4px 8px; border-radius: 4px; font-family: monospace;">${taskDirectory}</code>
                    </div>
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <strong>å¦‚ä½•è®¿é—®æ–‡ä»¶:</strong><br>
                        1. å¤åˆ¶ä¸Šé¢çš„è·¯å¾„<br>
                        2. åœ¨æ–‡ä»¶ç®¡ç†å™¨ä¸­æ‰“å¼€è¯¥è·¯å¾„<br>
                        3. æŸ¥çœ‹Claudeç”Ÿæˆçš„æ‰€æœ‰æ–‡ä»¶
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="copyToClipboard('${taskDirectory}')" style="background: #28a745; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;">ğŸ“‹ å¤åˆ¶è·¯å¾„</button>
                        <button onclick="this.closest('div').parentNode.remove()" style="background: #667eea; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;">å…³é—­</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showAlert('success', 'ğŸ“‹ è·¯å¾„å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                showAlert('error', 'å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            });
        }

        // å·¥å…·å‡½æ•°
        function getTaskTypeText(task) {
            switch (task.type) {
                case 'immediate': return `âš¡ ${window.i18n.t('taskList.type.immediate')}`;
                case 'scheduled': {
                    if (task.scheduledTime && task.scheduledTime !== 'null') {
                        try {
                            // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯åªæœ‰æ—¶é—´çš„æ ¼å¼ï¼ˆå¦‚ "13:13"ï¼‰
                            if (/^\d{1,2}:\d{2}$/.test(task.scheduledTime)) {
                                console.warn('ä»»åŠ¡è°ƒåº¦æ—¶é—´æ ¼å¼å¼‚å¸¸:', task.scheduledTime);
                                return `â° ${task.scheduledTime} (format error)`;
                            }
                            
                            // å®‰å…¨è§£ææ—¶é—´æ ¼å¼
                            const scheduledDate = new Date(task.scheduledTime);
                            if (isNaN(scheduledDate.getTime())) {
                                console.warn('ä»»åŠ¡è°ƒåº¦æ—¶é—´æ— æ³•è§£æ:', task.scheduledTime);
                                return `â° ${task.scheduledTime}`;
                            }
                            return `â° ${scheduledDate.toLocaleString()}`;
                        } catch (e) {
                            console.warn('ä»»åŠ¡è°ƒåº¦æ—¶é—´è§£æå¼‚å¸¸:', e, task.scheduledTime);
                            return `â° ${task.scheduledTime}`;
                        }
                    }
                    return `â° ${window.i18n.t('taskList.type.scheduled')}`;
                }
                case 'smart': return `ğŸ¤– ${window.i18n.t('taskForm.smart')}`;
                default: return 'â“ Unknown';
            }
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'â³ ç­‰å¾…ä¸­',
                'running': 'ğŸ”„ æ‰§è¡Œä¸­',
                'completed': 'âœ… å·²å®Œæˆ',
                'failed': 'âŒ å¤±è´¥'
            };
            return statusMap[status] || status;
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr || dateTimeStr === 'null') return '--';
            try {
                // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯åªæœ‰æ—¶é—´çš„æ ¼å¼ï¼ˆå¦‚ "13:13"ï¼‰
                if (/^\d{1,2}:\d{2}$/.test(dateTimeStr)) {
                    console.warn('æ£€æµ‹åˆ°åªæœ‰æ—¶é—´çš„æ ¼å¼:', dateTimeStr);
                    return `${dateTimeStr} (æ ¼å¼å¼‚å¸¸)`;
                }
                
                const date = new Date(dateTimeStr);
                if (isNaN(date.getTime())) {
                    // å°è¯•å…¶ä»–è§£ææ–¹å¼
                    console.warn('æ ‡å‡†è§£æå¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹å¼:', dateTimeStr);
                    return `${dateTimeStr} (æ— æ³•è§£æ)`;
                }
                return date.toLocaleString();
            } catch (e) {
                console.warn('Date parsing error:', e, dateTimeStr);
                return `${dateTimeStr} (è§£æé”™è¯¯)`;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateConnectionStatus(status) {
            document.getElementById('connectionStatus').textContent = status;
        }

        function updateTaskStats() {
            const total = tasks.length;
            const pending = tasks.filter(t => t.status === 'pending').length;
            const running = tasks.filter(t => t.status === 'running').length;
            const completed = tasks.filter(t => t.status === 'completed').length;
            
            document.getElementById('taskStats').textContent = 
                `${total} tasks (${pending} pending, ${running} running, ${completed} completed)`;
        }

        function refreshAll() {
            showAlert('success', 'ğŸ”„ æ­£åœ¨åˆ·æ–°æ•°æ®...');
            refreshTokenStatus();
            refreshTasks();
        }

        function toggleSystem() {
            systemRunning = !systemRunning;
            const btn = document.getElementById('systemToggle');
            const status = document.getElementById('systemStatus');
            
            if (systemRunning) {
                btn.innerHTML = `â¸ï¸ <span data-i18n="actions.pauseSystem">${window.i18n.t('actions.pauseSystem') || 'Pause System'}</span>`;
                btn.className = 'btn btn-secondary';
                status.textContent = window.i18n.t('messages.systemRunning') || 'System Running';
                showAlert('success', `ğŸš€ ${window.i18n.t('messages.systemStarted') || 'System Started'}`);
            } else {
                btn.innerHTML = `â–¶ï¸ <span data-i18n="actions.startSystem">${window.i18n.t('actions.startSystem') || 'Start System'}</span>`;
                btn.className = 'btn btn-primary';
                status.textContent = window.i18n.t('messages.systemPaused') || 'System Paused';
                showAlert('warning', `â¸ï¸ ${window.i18n.t('messages.systemPaused') || 'System Paused'}`);
            }
        }

        function clearCompleted() {
            const completed = tasks.filter(t => t.status === 'completed');
            if (completed.length === 0) {
                showAlert('warning', 'æ²¡æœ‰å·²å®Œæˆçš„ä»»åŠ¡éœ€è¦æ¸…ç†');
                return;
            }
            
            if (confirm(`ç¡®å®šè¦æ¸…ç†${completed.length}ä¸ªå·²å®Œæˆçš„ä»»åŠ¡å—ï¼Ÿ`)) {
                // è¿™é‡Œåº”è¯¥è°ƒç”¨APIåˆ é™¤å·²å®Œæˆçš„ä»»åŠ¡
                showAlert('success', `å‡†å¤‡æ¸…ç†${completed.length}ä¸ªå·²å®Œæˆçš„ä»»åŠ¡`);
            }
        }

        function exportData() {
            const data = {
                exportTime: new Date().toISOString(),
                tokenData: tokenData,
                tasks: tasks
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vibecodetask_export_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showAlert('success', 'ğŸ“¤ æ•°æ®å·²å¯¼å‡º');
        }

        // æ˜¾ç¤ºæé†’
        function showAlert(type, message) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <span>${message}</span>
                <button class="alert-close" onclick="this.parentNode.remove()">&times;</button>
            `;
            
            container.appendChild(alert);
            
            // 5ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 5000);
        }

        // å†å²æ•°æ®åŠŸèƒ½
        let historyDetailsVisible = false;
        let currentChartType = 'token'; // 'token' æˆ– 'cost'
        
        // åˆ‡æ¢å›¾è¡¨ç±»å‹
        function switchChartType(type) {
            currentChartType = type;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('tokenBtn').classList.toggle('active', type === 'token');
            document.getElementById('costBtn').classList.toggle('active', type === 'cost');
            
            // é‡æ–°åŠ è½½å›¾è¡¨
            if (window.historyDataLoaded) {
                loadHistoryData();
            }
        }
        
        // åˆ‡æ¢å†å²è¯¦æƒ…æ˜¾ç¤º
        function toggleHistoryView() {
            const details = document.getElementById('historyDetails');
            const btn = document.getElementById('historyToggleBtn');
            
            historyDetailsVisible = !historyDetailsVisible;
            
            if (historyDetailsVisible) {
                details.style.display = 'block';
                btn.textContent = 'æ”¶èµ·è¯¦æƒ…';
                if (!window.historyDataLoaded) {
                    loadHistoryData();
                }
            } else {
                details.style.display = 'none';
                btn.textContent = 'å±•å¼€è¯¦æƒ…';
            }
        }
        
        // åŠ è½½å†å²æ•°æ®
        async function loadHistoryData() {
            const days = document.getElementById('historyDays')?.value || 30;
            
            try {
                const response = await fetch(`/api/history/${days}`);
                const data = await response.json();
                
                if (data.error) {
                    console.error('è·å–å†å²æ•°æ®å¤±è´¥:', data.error);
                    document.getElementById('historyChart').innerHTML = 'âš ï¸ è·å–æ•°æ®å¤±è´¥: ' + data.error;
                    return;
                }
                
                updateHistorySummary(data);
                updateHistoryChart(data.daily);
                updateHistoryList(data.daily);
                
                window.historyDataLoaded = true;
                
            } catch (error) {
                console.error('å†å²æ•°æ®è¯·æ±‚å¤±è´¥:', error);
                document.getElementById('historyChart').innerHTML = 'âš ï¸ ç½‘ç»œè¯·æ±‚å¤±è´¥';
            }
        }
        
        // æ›´æ–°å†å²æ¦‚è§ˆ
        function updateHistorySummary(data) {
            const summary = data.summary || {};
            const totals = data.totals || {};
            
            document.getElementById('totalDays').textContent = summary.totalDays || '--';
            document.getElementById('monthlyTokens').textContent = 
                totals.totalTokens ? (totals.totalTokens / 1000000).toFixed(1) + 'M' : '--';
            document.getElementById('monthlyCost').textContent = 
                totals.totalCost ? '$' + totals.totalCost.toFixed(2) : '--';
            document.getElementById('averageDaily').textContent = 
                summary.averageTokensPerDay ? (summary.averageTokensPerDay / 1000).toFixed(0) + 'K' : '--';
            
            const trendEmoji = {
                'increasing': `ğŸ“ˆ ${window.i18n.t('trends.increasing')}`,
                'decreasing': `ğŸ“‰ ${window.i18n.t('trends.decreasing')}`, 
                'stable': `ğŸ“Š ${window.i18n.t('trends.stable')}`
            };
            document.getElementById('usageTrend').textContent = 
                trendEmoji[summary.recentTrend] || '--';
        }
        
        // æ›´æ–°å†å²å›¾è¡¨ï¼ˆå¯åˆ‡æ¢çš„å•çº¿å›¾ï¼‰
        function updateHistoryChart(daily) {
            const chartContainer = document.getElementById('historyChart');
            
            if (!daily || daily.length === 0) {
                chartContainer.innerHTML = 'ğŸ“­ æ²¡æœ‰å†å²æ•°æ®';
                return;
            }
            
            // æ ¹æ®é€‰æ‹©çš„å¤©æ•°æ˜¾ç¤ºæ•°æ®
            const days = document.getElementById('historyDays')?.value || 30;
            const maxDataPoints = Math.min(parseInt(days), daily.length);
            const chartData = daily.slice(-maxDataPoints);
            
            // æ ¹æ®å½“å‰å›¾è¡¨ç±»å‹è·å–æ•°æ®èŒƒå›´
            let maxValue, minValue, dataExtractor, unit, color, label;
            
            if (currentChartType === 'token') {
                maxValue = Math.max(...chartData.map(d => d.totalTokens || 0));
                minValue = Math.min(...chartData.map(d => d.totalTokens || 0));
                dataExtractor = d => d.totalTokens;
                unit = 'M';
                color = '#4a90e2';
                label = 'Tokenä½¿ç”¨é‡';
            } else {
                maxValue = Math.max(...chartData.map(d => d.totalCost || 0));
                minValue = Math.min(...chartData.map(d => d.totalCost || 0));
                dataExtractor = d => d.totalCost;
                unit = '';
                color = '#e74c3c';
                label = 'è´¹ç”¨æˆæœ¬';
            }
            
            // SVGå›¾è¡¨å°ºå¯¸
            const width = 800;
            const height = 320;
            const padding = 40;
            const chartWidth = width - padding * 2;
            const chartHeight = height - padding * 2;
            
            // è®¡ç®—æ•°æ®ç‚¹åæ ‡
            const points = chartData.map((day, index) => {
                const x = padding + (index * chartWidth / (chartData.length - 1 || 1));
                const valueRange = maxValue - minValue || 1;
                const y = padding + chartHeight - ((dataExtractor(day) - minValue) / valueRange * chartHeight);
                return {
                    x: isNaN(x) ? padding : x,
                    y: isNaN(y) ? padding + chartHeight : y,
                    date: day.date,
                    tokens: day.totalTokens,
                    cost: day.totalCost,
                    value: dataExtractor(day)
                };
            });
            
            // æŸ±çŠ¶å›¾å°ºå¯¸è®¡ç®—
            const slotWidth = chartData.length > 0 ? (chartWidth / chartData.length) : chartWidth;
            const barWidth = Math.max(8, slotWidth * 0.6);
            
            // Yè½´åˆ»åº¦
            const yTicks = 5;
            const ticksData = [];
            for (let i = 0; i <= yTicks; i++) {
                const value = minValue + (maxValue - minValue) * i / yTicks;
                const y = padding + chartHeight - (i * chartHeight / yTicks);
                let displayValue;
                if (currentChartType === 'token') {
                    displayValue = (value / 1000000).toFixed(1) + 'M';
                } else {
                    displayValue = '$' + value.toFixed(1);
                }
                ticksData.push({
                    y: y,
                    value: displayValue
                });
            }
            
            chartContainer.innerHTML = `
                <div style="position: relative; overflow-x: auto;">
                    <svg width="${width}" height="${height}" style="border-radius: 12px; background: linear-gradient(135deg, #fafbfc 0%, #ffffff 100%); box-shadow: 0 4px 20px rgba(0,0,0,0.06);">
                        <defs>
                            <linearGradient id="barGradient${currentChartType}" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:${color};stop-opacity:0.9" />
                                <stop offset="100%" style="stop-color:${color};stop-opacity:0.5" />
                            </linearGradient>
                            <filter id="shadow">
                                <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="${color}" flood-opacity="0.3"/>
                            </filter>
                        </defs>
                        
                        <!-- è½»é‡ç½‘æ ¼çº¿ -->
                        ${ticksData.slice(1, -1).map(tick => `
                            <line x1="${padding}" y1="${tick.y}" x2="${width - padding}" y2="${tick.y}" 
                                  stroke="#f8f9fa" stroke-width="1" stroke-dasharray="3,6" opacity="0.5"/>
                        `).join('')}
                        
                        <!-- Yè½´åˆ»åº¦å·²ç§»é™¤ï¼Œå›¾è¡¨æ›´ç®€æ´ -->
                        
                        <!-- æŸ±çŠ¶å›¾ -->
                        ${points.map((point, index) => {
                            const xLeft = padding + (index * chartWidth / (points.length || 1)) + ((slotWidth - barWidth) / 2);
                            const yTop = point.y;
                            const h = (padding + chartHeight) - yTop;
                            return `
                                <rect x="${xLeft}" y="${yTop}" width="${barWidth}" height="${h}" 
                                      fill="url(#barGradient${currentChartType})" rx="4" 
                                      style="cursor: pointer; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));"
                                      onmouseover="showPreciseTooltip(evt, '${point.date}', ${point.tokens}, ${point.cost}, '${currentChartType}')"
                                      onmousemove="showPreciseTooltip(evt, '${point.date}', ${point.tokens}, ${point.cost}, '${currentChartType}')"
                                      onmouseout="hideTooltip()" />
                            `;
                        }).join('')}

                        <!-- æŸ±é¡¶æ•°å€¼æ ‡ç­¾ï¼ˆæ¯ä¸€å¤©éƒ½æ˜¾ç¤ºï¼‰ -->
                        ${points.map((point) => {
                            const valueText = currentChartType === 'token' 
                                ? (point.value / 1000000).toFixed(1) + 'M'
                                : '$' + (point.value).toFixed(1);
                            const yText = Math.max(padding + 12, point.y - 6);
                            return `
                                <text x="${point.x}" y="${yText}" text-anchor="middle" font-size="11" fill="#495057" font-weight="600">${valueText}</text>
                            `;
                        }).join('')}
                        
                        <!-- Xè½´æ—¥æœŸæ ‡ç­¾ -->
                        ${points.map((point, index) => {
                            let shouldShow = false;
                            if (chartData.length <= 7) shouldShow = true;
                            else if (chartData.length <= 15) shouldShow = index % 2 === 0;
                            else if (chartData.length <= 30) shouldShow = index % 3 === 0;
                            else shouldShow = index % 5 === 0;
                            
                            if (!shouldShow && index !== 0 && index !== points.length - 1) return '';
                            
                            const dateStr = point.date.split('-').slice(1).join('/');
                            return `
                                <text x="${point.x}" y="${height - 20}" text-anchor="middle" 
                                      font-size="11" fill="#6c757d" font-weight="500">${dateStr}</text>
                            `;
                        }).join('')}
                        
                        <!-- åæ ‡è½´ - ä»…ä¿ç•™åº•éƒ¨Xè½´ -->
                        <line x1="${padding}" y1="${padding + chartHeight}" x2="${width - padding}" y2="${padding + chartHeight}" 
                              stroke="#dee2e6" stroke-width="2"/>
                    </svg>
                    
                    <!-- ç²¾ç¡®å·¥å…·æç¤º -->
                    <div id="chartTooltip" style="position: absolute; background: linear-gradient(145deg, #2d3748 0%, #4a5568 100%); 
                         color: white; padding: 14px 18px; border-radius: 10px; font-size: 13px; display: none; 
                         pointer-events: none; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
                         backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); font-family: -apple-system, system-ui;">
                    </div>
                </div>
            `;
        }
        
        // ç²¾ç¡®çš„å›¾è¡¨å·¥å…·æç¤º
        function showPreciseTooltip(evt, date, tokens, cost, chartType) {
            const tooltip = document.getElementById('chartTooltip');
            if (tooltip) {
                const tokensFormatted = (tokens / 1000000).toFixed(2) + 'M';
                const costFormatted = '$' + cost.toFixed(2);
                const tokensK = Math.round(tokens / 1000).toLocaleString() + 'K';
                
                tooltip.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 8px; font-size: 14px;">${date}</div>
                    ${chartType === 'token' ? `
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <div style="width: 8px; height: 8px; background: #4a90e2; border-radius: 50%;"></div>
                            <div>Token: <strong>${tokensFormatted}</strong> <span style="opacity: 0.7;">(${tokensK})</span></div>
                        </div>
                        <div style="color: #cbd5e0; font-size: 12px;">å¯¹åº”è´¹ç”¨: ${costFormatted}</div>
                    ` : `
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <div style="width: 8px; height: 8px; background: #e74c3c; border-radius: 50%;"></div>
                            <div>è´¹ç”¨: <strong>${costFormatted}</strong></div>
                        </div>
                        <div style="color: #cbd5e0; font-size: 12px;">Token: ${tokensFormatted}</div>
                    `}
                `;
                
                // æ™ºèƒ½å®šä½ï¼Œé¿å…è¶…å‡ºå±å¹•
                const rect = tooltip.getBoundingClientRect();
                let left = evt.pageX + 12;
                let top = evt.pageY - 12;
                
                if (left + 200 > window.innerWidth) {
                    left = evt.pageX - 200;
                }
                if (top < 0) {
                    top = evt.pageY + 12;
                }
                
                tooltip.style.display = 'block';
                tooltip.style.left = left + 'px';
                tooltip.style.top = top + 'px';
            }
        }
        
        function hideTooltip() {
            const tooltip = document.getElementById('chartTooltip');
            if (tooltip) {
                tooltip.style.display = 'none';
            }
        }
        
        // æ›´æ–°å†å²åˆ—è¡¨
        function updateHistoryList(daily) {
            const listContainer = document.getElementById('historyList');
            
            if (!daily || daily.length === 0) {
                listContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #6c757d;">æ²¡æœ‰å†å²æ•°æ®</div>';
                return;
            }
            
            const listHtml = daily.reverse().map(day => {
                const tokensM = ((day.totalTokens || 0) / 1000000).toFixed(2);
                const cost = (day.totalCost || 0).toFixed(2);
                const models = (day.modelsUsed || []).join(', ');
                
                return `
                    <div class="history-item">
                        <div class="history-date">${day.date}</div>
                        <div class="history-stats">
                            <div class="history-stat">
                                <div class="history-stat-value">${tokensM}M</div>
                                <div class="history-stat-label">Tokens</div>
                            </div>
                            <div class="history-stat">
                                <div class="history-stat-value">$${cost}</div>
                                <div class="history-stat-label">æˆæœ¬</div>
                            </div>
                            <div class="history-stat">
                                <div class="history-stat-value" style="font-size: 11px; max-width: 100px; overflow: hidden; text-overflow: ellipsis;">${models || '--'}</div>
                                <div class="history-stat-label">æ¨¡å‹</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            listContainer.innerHTML = listHtml;
        }
        
        // å¯åŠ¨æ—¶åŠ è½½å†å²æ¦‚è§ˆæ•°æ®
        async function loadHistorySummary() {
            try {
                const response = await fetch('/api/history/30');
                const data = await response.json();
                
                if (!data.error) {
                    updateHistorySummary(data);
                }
            } catch (error) {
                console.error('åŠ è½½å†å²æ¦‚è§ˆå¤±è´¥:', error);
            }
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
        
        // Handle browser back/forward navigation
        window.addEventListener('popstate', (event) => {
            if (event.state && event.state.lang) {
                // Language change via browser navigation
                window.i18n.setLanguage(event.state.lang, false);
            } else {
                // Check URL for language
                const lang = window.i18n.getLangFromURL();
                if (lang && lang !== window.i18n.getCurrentLanguage()) {
                    window.i18n.setLanguage(lang, false);
                }
            }
        });
    </script>
</body>
</html>